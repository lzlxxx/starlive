input {
  stdin { }
  jdbc {
    # mysql 数据库链接, shop为数据库名
    jdbc_connection_string => "jdbc:mysql://localhost:8888/StarLive?characterEncoding=utf8&useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true"
    # 用户名和密码
    jdbc_user => "root"
    jdbc_password => "root"
    # 驱动
    jdbc_driver_library => "jar包位置"
    # 驱动类名
    jdbc_driver_class => "com.mysql.cj.jdbc.Driver"
    jdbc_paging_enabled => "true"
    jdbc_page_size => "500"
    # 执行的sql 文件路径+名称
    statement => "
    SELECT 
      e.id, 
      e.title, 
      e.description, 
      e.start_time AS startTime, 
      e.end_time AS endTime, 
      e.location, 
      e.organizer_id AS organizerId, 
      e.status, 
      e.del_flag AS delFlag, 
      e.poster_url AS posterUrl, 
      u.username AS organizerName, 
      JSON_ARRAYAGG(
        JSON_OBJECT(
          'scheduleId', es.id,
          'scheduleName', es.schedule_name,
          'scheduleTime', es.schedule_time,
          'scheduleLocation', es.location,
          'scheduleDescription', es.description
        )
      ) AS schedule,
      JSON_ARRAYAGG(
        JSON_OBJECT(
          'rewardId', er.id, 
          'rewardName', er.reward_name, 
          'rewardDescription', er.description, 
          'rewardQuantity', er.quantity
        )
      ) AS rewards,
     ST_X(e.location_point) AS X, -- 提取经度
     ST_Y(e.location_point) AS Y   -- 提取纬度
    FROM events e
    LEFT JOIN event_schedule es ON e.id = es.event_id
    LEFT JOIN event_rewards er ON e.id = er.event_id
    LEFT JOIN users u ON e.organizer_id = u.user_id
    WHERE e.del_flag = 0
    GROUP BY e.id, u.user_id
  "

    # 设置监听间隔 各字段含义（由左至右）分、时、天、月、年，全部为*默认含义为每分钟都更新
    schedule => "* * * * *"
    # 索引类型
    type => "_doc"
    lowercase_column_names => false
  }
}


filter {
  aggregate {
    task_id => "%{id}"
    code => "
      map['id'] = event['id']
      map['title'] = event['title']
      map['description'] = event['description']
      map['startTime'] = event['startTime']
      map['endTime'] = event['endTime']
      map['location'] = event['location']
      map['organizerId'] = event['organizerId']
      map['status'] = event['status']
      map['delFlag'] = event['delFlag']
      map['posterUrl'] = event['posterUrl']
      map['organizerName'] = event['organizerName']
      
      # Initialize lists if they do not exist
      map['schedule'] ||= []
      map['rewards'] ||= []
      map['locationPoint'] ||= []
      map['locationPoint'] << {
                'lat' => event['X'],
                'lon' => event['Y']
      }

      # Process schedule data
      if(event.get('scheduleId') != nil)
        map['schedule'] << {
          'scheduleId' => event['scheduleId'],
          'scheduleName' => event['scheduleName'],
          'scheduleTime' => event['scheduleTime'],
          'scheduleLocation' => event['scheduleLocation'],
          'scheduleDescription' => event['scheduleDescription']
        }
      end

      # Process rewards data
      if(event.get('rewardId') != nil)
        map['rewards'] << {
          'rewardId' => event['rewardId'],
          'rewardName' => event['rewardName'],
          'rewardDescription' => event['rewardDescription'],
          'rewardQuantity' => event['rewardQuantity']
        }
      end



      event.cancel()
    "
    push_previous_map_as_event => true
    timeout => 3
  }
   json {
    source => "schedule"
    target => "schedule"
}

json {
    source => "rewards"
    target => "rewards"
}


     mutate  {
        #将不需要的JSON字段过滤，且不会被存入 ES 中
        remove_field => ["tags", "@timestamp", "@version","type"]
          convert => { "delFlag" => "integer" }
  }
}

output {
  elasticsearch {
    hosts => ["http://ip:9200"]
    user => "username"
    password => "password"
    index => "events"
    document_type => "_doc"
    document_id => "%{id}"
    action => "update"
    doc_as_upsert => true

  }
 stdout {
        codec => "rubydebug"
    }
}