<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>活动聊天</title>
    <style>
        .chat-container {
            width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-list {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
        }
        .message.self {
            background-color: #e3f2fd;
            text-align: right;
        }
        .message.other {
            background-color: #f5f5f5;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .input-container textarea {
            flex: 1;
            height: 60px;
        }
        .sync-container {
            margin-bottom: 20px;
        }
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .login-container input {
            width: 200px;
            padding: 5px;
            margin: 10px 0;
        }
        .chat-container {
            display: none;  /* 初始隐藏聊天界面 */
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginForm">
        <h2>加入活动</h2>
        <input type="text" id="userId" placeholder="输入您的用户ID"><br>
        <input type="text" id="activityId" placeholder="输入活动ID"><br>
        <button onclick="startChat()">加入活动</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="sync-container">
            <input type="datetime-local" id="startTime">
            <input type="datetime-local" id="endTime">
            <input type="number" id="page" value="0" min="0">
            <button onclick="syncMessages()">同步消息</button>
        </div>
        <div class="message-list" id="messageList"></div>
        <div class="input-container">
            <textarea id="messageInput" placeholder="请输入消息"></textarea>
            <button onclick="sendMessage()">发送</button>
        </div>
    </div>

    <script>
        let ws;
        let userId;
        let activityId;
        
        function startChat() {
            userId = document.getElementById('userId').value.trim();
            activityId = document.getElementById('activityId').value.trim();
            
            if (!userId || !activityId) {
                alert('请输入用户ID和活动ID');
                return;
            }
            
            // 隐藏登录界面，显示聊天界面
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            
            // 连接WebSocket
            connect();
        }

        function connect() {
            ws = new WebSocket('ws://localhost:8087/ws');
            
            ws.onopen = function() {
                console.log('WebSocket连接已建立');
                // 发送连接消息
                sendConnectMessage();
                // 加入活动
                joinActivity();
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                displayMessage(message);
            };
            
            ws.onclose = function() {
                console.log('WebSocket连接已关闭');
                // 尝试重连
                setTimeout(connect, 3000);
            };
        }

        function sendConnectMessage() {
            const message = {
                type: 'CONNECT',
                fromUserId: userId,
                activityId: activityId,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
        }

        function joinActivity() {
            const message = {
                type: 'JOIN_ACTIVITY',
                fromUserId: userId,
                activityId: activityId,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
        }

        function syncMessages() {
            const startTime = document.getElementById('startTime').value.replace('T', ' ') + ':00';
            const endTime = document.getElementById('endTime').value.replace('T', ' ') + ':00';
            const page = document.getElementById('page').value;

            const message = {
                type: 'CONNECT',
                fromUserId: userId,
                activityId: activityId,
                syncStartTime: startTime,
                syncEndTime: endTime,
                page: parseInt(page)
            };
            ws.send(JSON.stringify(message));
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value;
            if (!content.trim()) return;

            const message = {
                type: 'ACTIVITY_CHAT',
                fromUserId: userId,
                activityId: activityId,
                content: content,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

        function displayMessage(message) {
            const messageList = document.getElementById('messageList');
            const div = document.createElement('div');
            div.className = `message ${message.fromUserId === userId ? 'self' : 'other'}`;
            
            const time = new Date(message.timestamp).toLocaleString();
            div.innerHTML = `
                <div>${message.fromUserId}: ${message.content}</div>
                <small>${time}</small>
            `;
            
            messageList.appendChild(div);
            messageList.scrollTop = messageList.scrollHeight;
        }

        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // 页面关闭前离开活动
        window.onbeforeunload = function() {
            const message = {
                type: 'LEAVE_ACTIVITY',
                fromUserId: userId,
                activityId: activityId,
                timestamp: new Date().toISOString()
            };
            ws.send(JSON.stringify(message));
        };
    </script>
</body>
</html> 