<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>直播间聊天</title>
    <style>
        .chat-container {
            width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-list {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            background-color: rgba(0, 0, 0, 0.05);
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
            border-radius: 5px;
        }
        .message.self {
            background-color: #e3f2fd;
            text-align: right;
            margin-left: 20%;
        }
        .message.other {
            background-color: #f5f5f5;
            margin-right: 20%;
        }
        .message.system {
            background-color: #fff3e0;
            text-align: center;
            font-style: italic;
            color: #666;
        }
        .input-container {
            display: flex;
            gap: 10px;
        }
        .input-container textarea {
            flex: 1;
            height: 60px;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            resize: none;
        }
        .input-container button {
            padding: 0 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #1565c0;
        }
        .sync-container {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .sync-container input {
            padding: 5px;
            border-radius: 3px;
            border: 1px solid #ccc;
        }
        .sync-container button {
            padding: 5px 15px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .login-container input {
            width: 200px;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .login-container button {
            padding: 8px 20px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .chat-container {
            display: none;
        }
        .online-count {
            text-align: right;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginForm">
        <h2>加入直播间</h2>
        <input type="text" id="userId" placeholder="输入您的用户ID"><br>
        <input type="text" id="roomId" placeholder="输入直播间ID"><br>
        <button onclick="startChat()">加入直播间</button>
    </div>

    <div class="chat-container" id="chatContainer">
        <div class="online-count" id="onlineCount">在线人数: 0</div>
        <div class="sync-container">
            <input type="datetime-local" id="startTime">
            <input type="datetime-local" id="endTime">
            <input type="number" id="page" value="0" min="0">
            <button onclick="syncMessages()">同步消息</button>
        </div>
        <div class="message-list" id="messageList"></div>
        <div class="input-container">
            <textarea id="messageInput" placeholder="请输入消息" onkeydown="if(event.keyCode==13 && !event.shiftKey){sendMessage();return false;}"></textarea>
            <button onclick="sendMessage()">发送</button>
        </div>
    </div>

    <script>
        let ws;
        let userId;
        let roomId;
        let currentPage = 0;
        let isLoading = false;
        let noMoreMessages = false;
        
        function startChat() {
            userId = document.getElementById('userId').value.trim();
            roomId = document.getElementById('roomId').value.trim();
            
            if (!userId || !roomId) {
                alert('请输入用户ID和直播间ID');
                return;
            }
            
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('chatContainer').style.display = 'block';
            
            connect();
        }

        function connect() {
            ws = new WebSocket('ws://localhost:8087/ws');
            
            ws.onopen = function() {
                console.log('WebSocket连接已建立');
                sendConnectMessage();
                joinRoom();
                startHeartbeat();
                initScrollListener();
            };
            
            ws.onmessage = function(event) {
                const message = JSON.parse(event.data);
                if (message.type === 'SYSTEM' && message.content.startsWith('当前在线人数')) {
                    updateOnlineCount(message.content);
                } else {
                    displayMessage(message);
                }
            };
            
            ws.onclose = function() {
                console.log('WebSocket连接已关闭');
                stopHeartbeat();
                setTimeout(connect, 3000);
            };
        }

        function updateOnlineCount(content) {
            document.getElementById('onlineCount').textContent = content;
        }

        function sendConnectMessage() {
            const message = {
                type: 'CONNECT',
                fromUserId: userId,
                roomId: roomId,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
        }

        function joinRoom() {
            const message = {
                type: 'JOIN_ROOM',
                fromUserId: userId,
                roomId: roomId,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
        }

        function syncMessages() {
            const startTime = document.getElementById('startTime').value.replace('T', ' ') + ':00';
            const endTime = document.getElementById('endTime').value.replace('T', ' ') + ':00';
            const page = document.getElementById('page').value;

            const message = {
                type: 'SYNC_MESSAGE',
                fromUserId: userId,
                roomId: roomId,
                syncStartTime: startTime,
                syncEndTime: endTime,
                page: parseInt(page)
            };
            ws.send(JSON.stringify(message));
        }

        function sendMessage() {
            const content = document.getElementById('messageInput').value.trim();
            if (!content) return;

            const message = {
                type: 'ROOM_CHAT',
                fromUserId: userId,
                roomId: roomId,
                content: content,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
            document.getElementById('messageInput').value = '';
        }

        function initScrollListener() {
            const messageList = document.getElementById('messageList');
            messageList.addEventListener('scroll', function() {
                if (messageList.scrollTop <= 50 && !isLoading && !noMoreMessages) {
                    loadMoreMessages();
                }
            });
        }

        function loadMoreMessages() {
            isLoading = true;
            currentPage++;
            
            const messages = document.querySelectorAll('#messageList .message small');
            let endTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
            if (messages.length > 0) {
                endTime = messages[0].textContent;
            }
            
            const startTime = new Date(new Date(endTime) - 30*24*60*60*1000)
                .toISOString().slice(0, 19).replace('T', ' ');
            
            const message = {
                type: 'SYNC_MESSAGE',
                fromUserId: userId,
                roomId: roomId,
                syncStartTime: startTime,
                syncEndTime: endTime,
                page: currentPage
            };
            ws.send(JSON.stringify(message));
        }

        function displayMessage(message) {
            if (message.type === 'HEARTBEAT' || !message.content) {
                return;
            }
            
            const messageList = document.getElementById('messageList');
            const div = document.createElement('div');
            
            if (message.type === 'SYSTEM') {
                div.className = 'message system';
            } else {
                div.className = `message ${message.fromUserId === userId ? 'self' : 'other'}`;
            }
            
            const userName = message.fromUserName || message.fromUserId || 'Unknown';
            const content = message.content || '';
            
            div.innerHTML = message.type === 'SYSTEM' ? 
                `<div>${content}</div>` :
                `<div>${userName}: ${content}</div>
                 <small>${message.timestamp}</small>`;
            
            const scrollPos = messageList.scrollHeight - messageList.scrollTop;
            
            if (currentPage > 0) {
                messageList.insertBefore(div, messageList.firstChild);
                messageList.scrollTop = messageList.scrollHeight - scrollPos;
            } else {
                messageList.appendChild(div);
                messageList.scrollTop = messageList.scrollHeight;
            }
            
            if (message.type === 'SYNC_MESSAGE' && message.content === 'NO_MORE_MESSAGES') {
                noMoreMessages = true;
            }
            
            isLoading = false;
        }

        let heartbeatInterval;

        function startHeartbeat() {
            heartbeatInterval = setInterval(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    const heartbeat = {
                        type: 'HEARTBEAT',
                        fromUserId: userId,
                        timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
                    };
                    ws.send(JSON.stringify(heartbeat));
                }
            }, 30000);
        }

        function stopHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }
        }

        window.onbeforeunload = function() {
            const message = {
                type: 'LEAVE_ROOM',
                fromUserId: userId,
                roomId: roomId,
                timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
            };
            ws.send(JSON.stringify(message));
        };
    </script>
</body>
</html> 