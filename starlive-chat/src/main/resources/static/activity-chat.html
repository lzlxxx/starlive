<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>活动聊天</title>
    <style>
        .chat-container {
            width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .message-list {
            height: 400px;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }
        .message {
            margin-bottom: 10px;
            padding: 5px;
        }
        .message.self {
            background-color: #e3f2fd;
            text-align: right;
        }
        .message.other {
            background-color: #f5f5f5;
        }
        .input-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-container textarea {
            flex: 1;
            height: 60px;
        }
        .sync-container {
            margin-bottom: 20px;
        }
        .login-container {
            width: 300px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
        }
        .login-container input {
            width: 200px;
            padding: 5px;
            margin: 10px 0;
        }
        .chat-container {
            display: none;  /* 初始隐藏聊天界面 */
        }
        .input-container button {
            padding: 8px 15px;
            background-color: #1976d2;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .input-container button:hover {
            background-color: #1565c0;
        }
        .message img {
            margin-top: 5px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
            max-width: 200px;
            max-height: 200px;
            object-fit: contain;
        }
        .message img:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
<div class="login-container" id="loginForm">
    <h2>加入活动</h2>
    <input type="text" id="userId" placeholder="输入您的用户ID"><br>
    <input type="text" id="activityId" placeholder="输入活动ID"><br>
    <button onclick="startChat()">加入活动</button>
</div>

<div class="chat-container" id="chatContainer">
    <div class="sync-container">
        <input type="datetime-local" id="startTime">
        <input type="datetime-local" id="endTime">
        <input type="number" id="page" value="0" min="0">
        <button onclick="syncMessages()">同步消息</button>
    </div>
    <div class="message-list" id="messageList"></div>
    <div class="input-container">
        <textarea id="messageInput" placeholder="请输入消息" onkeydown="if(event.keyCode==13 && !event.shiftKey){sendMessage();return false;}"></textarea>
        <input type="file" id="imageInput" accept="image/*" style="display: none" onchange="handleImageSelect()">
        <button onclick="document.getElementById('imageInput').click()">选择图片</button>
        <button onclick="sendMessage()">发送</button>
    </div>
</div>

<script>
    let ws;
    let userId;
    let activityId;

    // 添加页码变量和锁定变量
    let currentPage = 0;
    let isLoading = false;
    let noMoreMessages = false;

    function startChat() {
        userId = document.getElementById('userId').value.trim();
        activityId = document.getElementById('activityId').value.trim();

        if (!userId || !activityId) {
            alert('请输入用户ID和活动ID');
            return;
        }

        // 隐藏登录界面，显示聊天界面
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('chatContainer').style.display = 'block';

        // 连接WebSocket
        connect();
    }

    function connect() {
        ws = new WebSocket('ws://localhost:8087/ws');

        ws.onopen = function() {
            console.log('WebSocket连接已建立');
            // 发送连接消息
            sendConnectMessage();
            // 加入活动
            joinActivity();
            // 启动心跳
            startHeartbeat();
        };

        ws.onmessage = function(event) {
            const message = JSON.parse(event.data);
            displayMessage(message);
        };

        ws.onclose = function() {
            console.log('WebSocket连接已关闭');
            // 停止心跳
            stopHeartbeat();
            // 尝试重连
            setTimeout(connect, 3000);
        };
    }

    function sendConnectMessage() {
        const message = {
            type: 'CONNECT',
            fromUserId: userId,
            activityId: activityId,
            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
        };
        ws.send(JSON.stringify(message));
    }

    function joinActivity() {
        const message = {
            type: 'JOIN_ACTIVITY',
            fromUserId: userId,
            activityId: activityId,
            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
        };
        ws.send(JSON.stringify(message));
    }

    function syncMessages() {
        const startTime = document.getElementById('startTime').value.replace('T', ' ') + ':00';
        const endTime = document.getElementById('endTime').value.replace('T', ' ') + ':00';
        const page = document.getElementById('page').value;

        const message = {
            type: 'SYNC_MESSAGE',
            fromUserId: userId,
            activityId: activityId,
            syncStartTime: startTime,
            syncEndTime: endTime,
            page: parseInt(page)
        };
        ws.send(JSON.stringify(message));
    }

    function sendMessage() {
        const content = document.getElementById('messageInput').value;
        if (!content.trim()) return;

        const message = {
            type: 'ACTIVITY_CHAT',
            fromUserId: userId,
            activityId: activityId,
            content: content,
            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
        };
        ws.send(JSON.stringify(message));
        document.getElementById('messageInput').value = '';
    }

    // 监听滚动事件
    function initScrollListener() {
        const messageList = document.getElementById('messageList');
        messageList.addEventListener('scroll', function() {
            // 当滚动到顶部附近时加载更多消息
            if (messageList.scrollTop <= 50 && !isLoading && !noMoreMessages) {
                loadMoreMessages();
            }
        });
    }

    // 加载更多消息
    function loadMoreMessages() {
        isLoading = true;
        currentPage++;

        // 获取最早的消息时间作为结束时间
        const messages = document.querySelectorAll('#messageList .message small');
        let endTime = new Date().toISOString().slice(0, 19).replace('T', ' ');
        if (messages.length > 0) {
            endTime = messages[0].textContent;
        }

        // 计算开始时间（比如30天前）
        const startTime = new Date(new Date(endTime) - 30*24*60*60*1000)
            .toISOString().slice(0, 19).replace('T', ' ');

        const message = {
            type: 'SYNC_MESSAGE',
            fromUserId: userId,
            activityId: activityId,
            syncStartTime: startTime,
            syncEndTime: endTime,
            page: currentPage
        };
        ws.send(JSON.stringify(message));
    }

    // 修改displayMessage函数
    function displayMessage(message) {
        // 如果是心跳消息，不显示
        if (message.type === 'HEARTBEAT') {
            return;
        }

        const messageList = document.getElementById('messageList');
        const div = document.createElement('div');
        div.className = `message ${message.fromUserId === userId ? 'self' : 'other'}`;

        const userName = message.fromUserName || message.fromUserId || 'Unknown';
        const content = message.content || '';

        let messageContent = `<div>${userName}: ${content}</div>`;

        // 如果消息包含图片URL，显示图片
        if (message.imageUrl) {
            messageContent += `
                    <div>
                        <img src="${message.imageUrl}"
                             style="max-width: 200px; max-height: 200px;"
                             onclick="window.open(this.src)"
                             onerror="this.onerror=null; this.src='data:image/jpeg;base64,${message.imageData}'"/>
                    </div>`;
        }

        messageContent += `<small>${message.timestamp}</small>`;
        div.innerHTML = messageContent;

        // 记住当前滚动位置
        const scrollPos = messageList.scrollHeight - messageList.scrollTop;

        // 如果是加载更早的消息，插入到顶部
        if (currentPage > 0) {
            messageList.insertBefore(div, messageList.firstChild);
            messageList.scrollTop = messageList.scrollHeight - scrollPos;
        } else {
            messageList.appendChild(div);
            messageList.scrollTop = messageList.scrollHeight;
        }

        if (message.type === 'SYNC_MESSAGE' && message.content === 'NO_MORE_MESSAGES') {
            noMoreMessages = true;
        }

        isLoading = false;
    }

    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    // 页面关闭前离开活动
    window.onbeforeunload = function() {
        const message = {
            type: 'LEAVE_ACTIVITY',
            fromUserId: userId,
            activityId: activityId,
            timestamp: new Date().toISOString()
        };
        ws.send(JSON.stringify(message));
    };

    let heartbeatInterval;

    function startHeartbeat() {
        // 每30秒发送一次心跳
        heartbeatInterval = setInterval(() => {
            if (ws.readyState === WebSocket.OPEN) {
                const heartbeat = {
                    type: 'HEARTBEAT',
                    fromUserId: userId,
                    timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
                };
                ws.send(JSON.stringify(heartbeat));
            }
        }, 30000);
    }

    function stopHeartbeat() {
        if (heartbeatInterval) {
            clearInterval(heartbeatInterval);
        }
    }

    // 在页面加载完成后初始化
    window.onload = function() {
        // ... 其他初始化代码 ...
        initScrollListener();
    };

    // 在 script 标签中添加图片压缩函数
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            const maxWidth = 800;
            const maxHeight = 800;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    // 计算缩放比例
                    const scale = Math.min(1, Math.min(maxWidth / width, maxHeight / height));
                    width *= scale;
                    height *= scale;

                    canvas.width = width;
                    canvas.height = height;

                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // 使用更低的质量压缩
                    canvas.toBlob((blob) => {
                        const reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = function() {
                            const base64data = reader.result.split(',')[1];
                            resolve(base64data);
                        }
                    }, 'image/jpeg', 0.5); // 降低质量到0.5
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    // 修改 handleImageSelect 函数
    async function handleImageSelect() {
        const fileInput = document.getElementById('imageInput');
        const file = fileInput.files[0];

        if (file) {
            if (!file.type.startsWith('image/')) {
                alert('请选择图片文件');
                return;
            }

            try {
                // 压缩图片
                const compressedImage = await compressImage(file);
                sendImageMessage(compressedImage);
            } catch (error) {
                console.error('图片处理失败:', error);
                alert('图片处理失败，请重试');
            }
        }
    }

    // 修改 sendImageMessage 函数
    function sendImageMessage(base64Image) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('WebSocket连接已断开');
            return;
        }

        const message = {
            type: 'ACTIVITY_CHAT',
            messageId: generateUUID(),
            fromUserId: userId,
            fromUserName: userId,
            activityId: activityId,
            content: '发送了一张图片',
            imageData: base64Image,
            timestamp: new Date().toISOString().slice(0, 19).replace('T', ' ')
        };

        // 先显示本地预览
        const messageList = document.getElementById('messageList');
        const previewDiv = document.createElement('div');
        previewDiv.className = 'message self';
        const div = document.createElement('div');
        div.className = 'message self';
        div.innerHTML = `
                <div>${userId}: ${message.content}</div>
                <div><img src="data:image/jpeg;base64,${base64Image}" style="max-width: 200px; max-height: 200px;"></div>
                <small>${message.timestamp}</small>
            `;
        messageList.appendChild(div);
        messageList.scrollTop = messageList.scrollHeight;

        // 发送消息
        ws.send(JSON.stringify(message));

        // 清空文件输入
        document.getElementById('imageInput').value = '';
    }

    // 生成UUID的辅助函数
    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0,
                v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
</script>
</body>
</html> 